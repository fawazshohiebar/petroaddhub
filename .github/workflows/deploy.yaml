name: Trigger AWS Deployment

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: me-central-1 # Replace with your desired AWS region
  # Important: Ensure this matches the tag on your EC2 instances
  TARGET_VALUE: tf-adnec-adihex # Replace with your actual tag value
  DEPLOY_SCRIPT: /usr/local/bin/deploy-after-git-push.sh

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Get at least the last 2 commits to compare
      
      - name: üìã Get commit message
        id: get-commit
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "Commit message: $COMMIT_MESSAGE"
      
      - name: üöÄ Trigger AWS Systems Manager
        id: trigger-ssm
        run: |
          COMMAND_OUTPUT=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Project,Values=${{ env.TARGET_VALUE }}" \
            --parameters 'commands=[
              "export COMMIT_MESSAGE=\"${{ steps.get-commit.outputs.commit_message }}\"",
              "${{ env.DEPLOY_SCRIPT }}"
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output json)
          
          COMMAND_ID=$(echo "$COMMAND_OUTPUT" | jq -r '.Command.CommandId')
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Started deployment with Command ID: $COMMAND_ID"

      - name: ‚è≥ Wait for deployment completion
        run: |
          COMMAND_ID="${{ steps.trigger-ssm.outputs.command_id }}"
          echo "Waiting for deployment to complete (Command ID: $COMMAND_ID)..."
          
          # Get target instance ID
          INSTANCE_ID=$(aws ssm describe-instance-information \
            --filters "Key=tag:Project,Values=${{ env.TARGET_VALUE }}" \
            --query 'InstanceInformationList[0].InstanceId' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          echo "Target instance: $INSTANCE_ID"
          
          # Wait for command completion (timeout after 10 minutes)
          TIMEOUT=600
          ELAPSED=0
          STATUS="InProgress"
          
          while [ "$STATUS" = "InProgress" ] && [ $ELAPSED -lt $TIMEOUT ]; do
            echo "Checking deployment status... (${ELAPSED}s elapsed)"
            
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text \
              --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Pending")
            
            if [ "$STATUS" = "InProgress" ] || [ "$STATUS" = "Pending" ]; then
              sleep 15
              ELAPSED=$((ELAPSED + 15))
            fi
          done
          
          # Get final status and output
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "‚ùå Deployment timed out after ${TIMEOUT} seconds"
            exit 1
          fi
          
          echo "Deployment completed with status: $STATUS"
          
          # Get deployment output
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          ERROR_OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardErrorContent' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          echo "=== Deployment Output ==="
          echo "$OUTPUT"
          
          if [ -n "$ERROR_OUTPUT" ] && [ "$ERROR_OUTPUT" != "None" ]; then
            echo "=== Deployment Errors ==="
            echo "$ERROR_OUTPUT"
          fi
          
          # Check final status
          if [ "$STATUS" = "Success" ]; then
            echo "‚úÖ Deployment completed successfully!"
          else
            echo "‚ùå Deployment failed with status: $STATUS"
            exit 1
          fi
